// prisma/schemas/Workflow.prisma
// Workflow Automation System - Database Models
// Naming: camelCase for all fields

model Workflow {
    id          String   @id @default(cuid())
    name        String
    description String?
    ownerId     String
    isActive    Boolean  @default(true)
    version     Int      @default(1)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    nodes      WorkflowNode[]
    edges      WorkflowEdge[]
    executions WorkflowExecution[]
    triggers   Trigger[]
    nodeRuns   WorkflowNodeRun[]

    @@map("tbl_workflow")
}

model WorkflowNode {
    id          String   @id @default(cuid())
    workflowId  String
    type        String // e.g., "manual.trigger", "cron.trigger", "conditional", "http.request", "output"
    label       String?
    positionX   Float    @default(0)
    positionY   Float    @default(0)
    config      Json // node "sheet" config
    stateSchema Json? // optional zod/json schema snapshot
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    workflow      Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
    incomingEdges WorkflowEdge[]    @relation("TargetNode")
    outgoingEdges WorkflowEdge[]    @relation("SourceNode")
    nodeRuns      WorkflowNodeRun[]

    @@index([workflowId])
    @@map("tbl_workflow_node")
}

model WorkflowEdge {
    id           String   @id @default(cuid())
    workflowId   String
    sourceNodeId String
    targetNodeId String
    label        String?
    condition    Json? // conditional routing payload (true/false or named branch)
    config       Json?
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    workflow   Workflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
    sourceNode WorkflowNode @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
    targetNode WorkflowNode @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)

    @@index([workflowId])
    @@index([sourceNodeId])
    @@index([targetNodeId])
    @@map("tbl_workflow_edge")
}

enum ExecutionStatus {
    PENDING
    RUNNING
    SUCCESS
    FAILED
    CANCELED
    TIMED_OUT
}

model WorkflowExecution {
    id          String          @id @default(cuid())
    workflowId  String
    triggerType String // "manual" | "cron" | "api"
    status      ExecutionStatus @default(PENDING)
    startedAt   DateTime?
    finishedAt  DateTime?
    stateIn     Json? // global state input
    stateOut    Json? // global state output
    error       Json?
    createdAt   DateTime        @default(now())
    updatedAt   DateTime        @updatedAt

    workflow Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
    nodeRuns WorkflowNodeRun[]

    @@index([workflowId])
    @@index([status])
    @@map("tbl_workflow_execution")
}

enum NodeRunStatus {
    PENDING
    RUNNING
    SUCCESS
    FAILED
    SKIPPED
    CANCELED
}

model WorkflowNodeRun {
    id          String        @id @default(cuid())
    executionId String
    workflowId  String
    nodeId      String
    status      NodeRunStatus @default(PENDING)
    startedAt   DateTime?
    finishedAt  DateTime?
    input       Json? // resolved input after templating
    output      Json? // raw result from action
    error       Json?
    meta        Json? // debug meta (retries, attempts, timings)
    createdAt   DateTime      @default(now())
    updatedAt   DateTime      @updatedAt

    execution WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
    workflow  Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
    node      WorkflowNode      @relation(fields: [nodeId], references: [id], onDelete: Cascade)

    @@index([executionId])
    @@index([workflowId])
    @@index([nodeId])
    @@index([status])
    @@map("tbl_workflow_node_run")
}

model Trigger {
    id         String   @id @default(cuid())
    workflowId String
    type       String // "cron", "manual", "api"
    cronExpr   String? // cron expression if type=cron
    timezone   String?
    isActive   Boolean  @default(true)
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

    @@index([workflowId])
    @@index([type])
    @@map("tbl_trigger")
}

model WorkflowTemplate {
    id        String   @id @default(cuid())
    ownerId   String
    name      String
    content   String // handlebars template string
    kind      String   @default("template") // "partial" | "helper"
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([ownerId])
    @@map("tbl_workflow_template")
}
